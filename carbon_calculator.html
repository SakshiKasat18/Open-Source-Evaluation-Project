<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name='api-url' content='http://localhost:3001/api/calculate'>
  <title>Carbon Emission Calculator | BreatheGreen</title>
  <link rel="stylesheet" href="carbon_calculator.css" />
  <!-- Chart.js library for creating charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="logo"> <span>BreatheGreen</span></div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="eco_library.html">Eco Library</a></li>
      <li><a href="carbon_calculator.html">Carbon Emission Calculator</a></li>
    </ul>
  </nav>


  <section class="form-section">
    <h1>BreatheGreen</h1>
    <p class="tagline" style="text-align:center; font-style:italic; color:#0d6c34; margin-bottom:10px;">Make every choice a little lighter.</p>
    <p style="text-align:center;">Select who you want to calculate for:</p>


    <div class="choice-buttons">
      <button id="individualBtn"> Individual</button>
      <button id="familyBtn"> Family</button>
    </div>


    <form id="individualForm" class="vertical-form" style="display:none;">
      <h2>Individual Data</h2>

      <label>Travel Mode:</label>
      <select id="travelMode">
        <option value="car">Car</option>
        <option value="ev">EV</option>
        <option value="bus">Bus</option>
        <option value="train">Train</option>
        <option value="scooter">Scooter</option>
        <option value="walk">Walk</option>
        <option value="cycle">Cycle</option>
      </select>

      <label>Distance Travelled (km/month):</label>
      <input type="number" id="travelKm" required>

      <label>Diet Type:</label>
      <select id="diet">
        <option value="veg">Vegetarian</option>
        <option value="mixed">Mixed</option>
        <option value="meat">Non-Vegetarian</option>
      </select>

      <label>Electricity Usage (kWh/month):</label>
      <input type="number" id="kWh" required>

      <label>Waste Produced (kg/month):</label>
      <input type="number" id="waste" required>

      <button type="button" id="calcIndividual">Send Data</button>
    </form>


    <form id="familyForm" class="vertical-form" style="display:none;">
      <h2>Family Data</h2>

      <label>Total Family Members:</label>
      <input type="number" id="familyMembers" required>

      <label>Number of Vehicles:</label>
      <input type="number" id="vehicles" required>

      <label>Vehicle Type:</label>
      <select id="vehicleType">
        <option value="petrol">Petrol</option>
        <option value="ev">EV</option>
        <option value="diesel">diesel</option>
      </select>

      <label>Average Travel per Month (km per vehicle):</label>
      <input type="number" id="familyTravelKm" required>

      <label>Electricity Usage (kWh/month):</label>
      <input type="number" id="familyKwh" required>

      <label>Waste Produced (kg/month):</label>
      <input type="number" id="familyWaste" required>

      <label>Average Diet Type:</label>
      <select id="familyDiet">
        <option value="veg">Vegetarian</option>
        <option value="mixed">Mixed</option>
        <option value="meat">Non-Vegetarian</option>
      </select>

      <button type="button" id="calcFamily">Send Data</button>
    </form>

    <div id="result" style="margin-top:30px; text-align:center;"></div>
    
    <!-- What If? Machine Section -->
    <div id="whatIfSection" class="what-if-section" style="display:none;">
      <h3>üî• "What If?" Machine</h3>
      <p>See how much CO‚ÇÇ you'd save with better choices:</p>
      <div id="whatIfComparisons"></div>
    </div>
    
    <!-- Context Engine Section -->
    <div id="contextSection" class="context-section" style="display:none;">
      <h3>üî• Context Engine</h3>
      <div id="contextInsights"></div>
    </div>
    
    <!-- Add to Week Button -->
    <div id="addToWeekSection" style="display:none; text-align:center; margin:20px 0;">
      <button id="addToWeekBtn" class="add-to-week-btn">üìÖ Add to my week</button>
    </div>
    
    <!-- Weekly Tracker Section -->
    <div id="weeklyTrackerSection" class="weekly-tracker-section" style="display:none;">
      <h3>üìä Weekly Tracker</h3>
      <p>Your carbon footprint over the last 7 days:</p>
      <canvas id="weeklyChart"></canvas>
      <div id="weeklyStats"></div>
    </div>
    
    <!-- Chart 1: Gas Breakdown -->
    <div id="gasChartSection" class="chart-container" style="display:none;">
      <h3>üå´Ô∏è Greenhouse Gas Breakdown</h3>
      <canvas id="gasChart"></canvas>
    </div>
    
    <!-- Chart 2: Comparison with Global Average -->
    <div id="comparisonChartSection" class="chart-container" style="display:none;">
      <h3>üåç Your Emissions vs Global Average</h3>
      <canvas id="comparisonChart"></canvas>
    </div>
    
    <!-- Chart 3: Reduction Potential -->
    <div id="reductionChartSection" class="chart-container" style="display:none;">
      <h3>üìâ Monthly Reduction Potential</h3>
      <canvas id="reductionChart"></canvas>
    </div>
    
    <div id="suggestions" style="display:none;"></div>
  </section>

  <script>

    const individualBtn = document.getElementById("individualBtn");
    const familyBtn = document.getElementById("familyBtn");
    const individualForm = document.getElementById("individualForm");
    const familyForm = document.getElementById("familyForm");
    const resultDiv = document.getElementById("result");

    individualBtn.addEventListener("click", () => {
      individualForm.style.display = "flex";
      familyForm.style.display = "none";
      resultDiv.innerHTML = "";
    });

    familyBtn.addEventListener("click", () => {
      familyForm.style.display = "flex";
      individualForm.style.display = "none";
      resultDiv.innerHTML = "";
    });


    const API_URL = "http://localhost:3001/api/calculate";


    document.getElementById("calcIndividual").addEventListener("click", async () => {
      const payload = {
        type: "individual",
        travelMode: document.getElementById("travelMode").value,
        travelKm: document.getElementById("travelKm").value,
        diet: document.getElementById("diet").value,
        kWh: document.getElementById("kWh").value,
        waste: document.getElementById("waste").value,
      };

      resultDiv.innerHTML = "‚è≥ Calculating your carbon footprint...";
      resultDiv.style.display = "block";

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const apiData = await res.json();
        
        if (apiData.success) {
          resultDiv.innerHTML = `
            <h3>‚úÖ Your Carbon Footprint</h3>
            <p style="font-size:2rem; font-weight:bold; color:#118a3f;">
              ${apiData.data.totalEmissions} kg CO2e/month
            </p>
          `;
          
          // Show all features
          showAllCharts(apiData.data);
          showWhatIfMachine(payload, apiData.data);
          showContextEngine(apiData.data);
          showSuggestions(payload, apiData.data);
          
          // Show Add to Week button
          document.getElementById("addToWeekSection").style.display = "block";
          
          // Store current result for Add to Week
          window.currentResult = {
            date: new Date().toISOString(),
            emissions: apiData.data.totalEmissions,
            payload: payload
          };
        }
      } catch (err) {
        resultDiv.innerHTML = `<p style="color:red;">‚ùå Failed to reach backend API. Make sure server is running!</p>`;
      }
    });

  
    document.getElementById("calcFamily").addEventListener("click", async () => {
      const payload = {
        type: "family",
        members: document.getElementById("familyMembers").value,
        vehicles: document.getElementById("vehicles").value,
        vehicleType: document.getElementById("vehicleType").value,
        familyTravelKm: document.getElementById("familyTravelKm").value,
        kWh: document.getElementById("familyKwh").value,
        waste: document.getElementById("familyWaste").value,
        diet: document.getElementById("familyDiet").value,
      };

      resultDiv.innerHTML = "‚è≥ Calculating your carbon footprint...";
      resultDiv.style.display = "block";

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const apiData = await res.json();
        
        if (apiData.success) {
          resultDiv.innerHTML = `
            <h3>‚úÖ Your Carbon Footprint</h3>
            <p style="font-size:2rem; font-weight:bold; color:#118a3f;">
              ${apiData.data.totalEmissions} kg CO2e/month
            </p>
          `;
          
          // Show all features
          showAllCharts(apiData.data);
          showWhatIfMachine(payload, apiData.data);
          showContextEngine(apiData.data);
          showSuggestions(payload, apiData.data);
          
          // Show Add to Week button
          document.getElementById("addToWeekSection").style.display = "block";
          
          // Store current result for Add to Week
          window.currentResult = {
            date: new Date().toISOString(),
            emissions: apiData.data.totalEmissions,
            payload: payload
          };
        }
      } catch (err) {
        resultDiv.innerHTML = `<p style="color:red;">‚ùå Failed to reach backend API. Make sure server is running!</p>`;
      }
    });

    // Variables to store chart instances
    let gasChart = null;
    let comparisonChart = null;
    let reductionChart = null;
    let weeklyChart = null;

    // Function to show all three charts
    function showAllCharts(apiData) {
      showGasChart(apiData.gasBreakdown);
      showComparisonChart(apiData.comparison);
      showReductionChart(apiData.reduction);
    }

    // Chart 1: Gas Breakdown (Pie Chart)
    function showGasChart(gasData) {
      document.getElementById("gasChartSection").style.display = "block";
      
      if (gasChart) gasChart.destroy();
      
      const ctx = document.getElementById("gasChart").getContext("2d");
      gasChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["CO2", "CH4 (Methane)", "N2O (Nitrous Oxide)"],
          datasets: [{
            data: [gasData.co2, gasData.ch4, gasData.n2o],
            backgroundColor: ["#ff6b6b", "#ffa94d", "#74c0fc"],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ": " + context.parsed + " kg/month";
                }
              }
            }
          }
        }
      });
    }

    // Chart 2: Comparison with Global Average (Bar Chart)
    function showComparisonChart(compData) {
      document.getElementById("comparisonChartSection").style.display = "block";
      
      if (comparisonChart) comparisonChart.destroy();
      
      const ctx = document.getElementById("comparisonChart").getContext("2d");
      comparisonChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Your Emissions", "Global Average"],
          datasets: [{
            label: "kg CO2e/month",
            data: [compData.yourEmissions, compData.globalAverage],
            backgroundColor: [
              compData.yourEmissions > compData.globalAverage ? "#ff6b6b" : "#51cf66",
              "#94d2bd"
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "kg CO2e per month" }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                afterLabel: function(context) {
                  if (context.dataIndex === 0) {
                    return "Difference: " + compData.difference + " kg (" + compData.percentDiff + "%)";
                  }
                  return "";
                }
              }
            }
          }
        }
      });
    }

    // Chart 3: Reduction Potential (Bar Chart)
    function showReductionChart(redData) {
      document.getElementById("reductionChartSection").style.display = "block";
      
      if (reductionChart) reductionChart.destroy();
      
      const ctx = document.getElementById("reductionChart").getContext("2d");
      reductionChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Current Emissions", "After Following Suggestions"],
          datasets: [{
            label: "kg CO2e/month",
            data: [redData.current, redData.afterReduction],
            backgroundColor: ["#ff6b6b", "#51cf66"],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "kg CO2e per month" }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                afterLabel: function(context) {
                  if (context.dataIndex === 1) {
                    return "Reduction: " + redData.potential + " kg (" + redData.percentReduction + "%)";
                  }
                  return "";
                }
              }
            }
          }
        }
      });
    }

    // Function to show personalized suggestions
    function showSuggestions(data, apiData) {
      const suggestionsDiv = document.getElementById("suggestions");
      let suggestions = "<h3>üí° Personalized Suggestions to Reduce Carbon Emissions:</h3><ul>";

      // Check travel mode and give suggestions
      if (data.travelMode === "car") {
        suggestions += "<li>üöó <strong>Switch to Public Transport:</strong> Use bus or train instead of car to reduce emissions by up to 50%.</li>";
        suggestions += "<li>üö¥ <strong>Try Cycling or Walking:</strong> For short distances, cycling or walking produces zero emissions.</li>";
        suggestions += "<li>‚ö° <strong>Consider an Electric Vehicle:</strong> EVs produce much less carbon than petrol cars.</li>";
      }

      if (data.travelMode === "scooter") {
        suggestions += "<li>üõ¥ <strong>Use Public Transport:</strong> Buses and trains are more eco-friendly for longer distances.</li>";
        suggestions += "<li>üö¥ <strong>Switch to Cycling:</strong> For nearby places, cycling is healthier and emission-free.</li>";
      }

      if (data.vehicleType === "petrol" || data.vehicleType === "diesel") {
        suggestions += "<li>‚ö° <strong>Upgrade to Electric Vehicle:</strong> EVs have lower carbon footprint than petrol/diesel vehicles.</li>";
        suggestions += "<li>üöå <strong>Carpool or Use Public Transport:</strong> Share rides to reduce the number of vehicles on road.</li>";
      }

      // Check electricity usage and give suggestions
      if (data.kWh > 200 || data.familyKwh > 500) {
        suggestions += "<li>üí° <strong>Use LED Bulbs:</strong> Replace old bulbs with LED to save up to 75% energy.</li>";
        suggestions += "<li>üåû <strong>Install Solar Panels:</strong> Generate clean energy and reduce electricity bills.</li>";
        suggestions += "<li>‚ùÑÔ∏è <strong>Use Energy-Efficient Appliances:</strong> Choose 5-star rated appliances to consume less power.</li>";
        suggestions += "<li>üîå <strong>Unplug Devices:</strong> Turn off devices when not in use to avoid standby power consumption.</li>";
      }

      // Check diet and give suggestions
      if (data.diet === "meat") {
        suggestions += "<li>ü•ó <strong>Reduce Meat Consumption:</strong> Eating less meat can reduce your carbon footprint significantly.</li>";
        suggestions += "<li>üå± <strong>Try Plant-Based Meals:</strong> Include more vegetables and plant-based proteins in your diet.</li>";
      }

      if (data.diet === "mixed") {
        suggestions += "<li>ü•ó <strong>Eat More Vegetables:</strong> Increase plant-based meals to lower your carbon impact.</li>";
      }

      // Check waste and give suggestions
      if (data.waste > 20 || data.familyWaste > 50) {
        suggestions += "<li>‚ôªÔ∏è <strong>Recycle More:</strong> Separate plastic, paper, and glass for recycling.</li>";
        suggestions += "<li>üóëÔ∏è <strong>Reduce Single-Use Plastics:</strong> Use reusable bags, bottles, and containers.</li>";
        suggestions += "<li>üçÇ <strong>Compost Organic Waste:</strong> Turn food scraps into compost instead of throwing them away.</li>";
      }

      suggestions += "</ul>";
      
      // Add summary info
      if (apiData && apiData.reduction) {
        suggestions += `<div style="margin-top:20px; padding:15px; background:#e7f5ff; border-radius:8px;">
          <p style="font-size:1.1rem; font-weight:600; color:#1971c2;">
            üí∞ By following these suggestions, you can reduce your carbon footprint by 
            <strong>${apiData.reduction.potential} kg CO2e/month</strong> 
            (${apiData.reduction.percentReduction}% reduction)!
          </p>
        </div>`;
      }
      
      // Show the suggestions on the page
      suggestionsDiv.innerHTML = suggestions;
      suggestionsDiv.style.display = "block";
    }
    
    // What If? Machine - Show comparisons with alternative choices
    async function showWhatIfMachine(data, apiData) {
      const whatIfSection = document.getElementById("whatIfSection");
      const comparisonsDiv = document.getElementById("whatIfComparisons");
      
      if (!data.travelMode && !data.vehicleType) {
        whatIfSection.style.display = "none";
        return;
      }
      
      const currentKm = parseFloat(data.travelKm || data.familyTravelKm || 0);
      if (currentKm === 0) {
        whatIfSection.style.display = "none";
        return;
      }
      
      const currentEmissions = apiData.categoryBreakdown.travel;
      let comparisons = "";
      
      // Calculate alternative emissions
      const alternatives = [
        { mode: "bus", label: "üöå Bus", factor: 0.5 },
        { mode: "train", label: "üöÇ Train", factor: 0.3 },
        { mode: "ev", label: "‚ö° Electric Vehicle", factor: 0.4 },
        { mode: "cycle", label: "üö¥ Cycle/Walk", factor: 0 }
      ];
      
      comparisons = "<div class='what-if-grid'>";
      
      for (const alt of alternatives) {
        const altEmissions = currentEmissions * alt.factor;
        const savings = currentEmissions - altEmissions;
        const savingsPercent = currentEmissions > 0 ? ((savings / currentEmissions) * 100).toFixed(1) : 0;
        
        comparisons += `
          <div class="what-if-card">
            <h4>${alt.label}</h4>
            <p class="emission-value">${altEmissions.toFixed(2)} kg CO‚ÇÇ/month</p>
            <p class="savings">üíö Save ${savings.toFixed(2)} kg (${savingsPercent}%)</p>
          </div>
        `;
      }
      
      comparisons += "</div>";
      comparisonsDiv.innerHTML = comparisons;
      whatIfSection.style.display = "block";
    }
    
    // Context Engine - Compare with India's average and UN 2030 targets
    function showContextEngine(apiData) {
      const contextSection = document.getElementById("contextSection");
      const insightsDiv = document.getElementById("contextInsights");
      
      const monthlyEmissions = apiData.totalEmissions;
      const yearlyEmissions = monthlyEmissions * 12;
      
      // India's average yearly emissions per person: ~4.2 tons = 4200 kg
      const indiaAverage = 4200; // kg per year
      const indiaPercent = ((yearlyEmissions / indiaAverage) * 100).toFixed(1);
      
      // UN 2030 target: ~2.5 tons = 2500 kg per person per year
      const unTarget = 2500; // kg per year
      const unPercent = ((yearlyEmissions / unTarget) * 100).toFixed(1);
      const overUnTarget = yearlyEmissions > unTarget;
      
      let insights = `
        <div class="context-card">
          <h4>üáÆüá≥ India's Yearly Average</h4>
          <p class="context-value">${indiaAverage} kg CO‚ÇÇ/year per person</p>
          <p class="context-comparison">Your yearly footprint: <strong>${yearlyEmissions.toFixed(1)} kg</strong></p>
          <p class="context-percent">That's <strong>${indiaPercent}%</strong> of India's average</p>
        </div>
        <div class="context-card ${overUnTarget ? 'over-target' : 'under-target'}">
          <h4>üåç UN 2030 Per-Person Target</h4>
          <p class="context-value">${unTarget} kg CO‚ÇÇ/year per person</p>
          <p class="context-comparison">Your yearly footprint: <strong>${yearlyEmissions.toFixed(1)} kg</strong></p>
          <p class="context-percent">
            ${overUnTarget 
              ? `‚ö†Ô∏è You're <strong>${unPercent}%</strong> over the UN target!` 
              : `‚úÖ You're <strong>${(100 - parseFloat(unPercent)).toFixed(1)}%</strong> under the UN target!`}
          </p>
          ${overUnTarget 
            ? `<p class="context-note">üí° To meet UN 2030 goals, reduce by ${(yearlyEmissions - unTarget).toFixed(1)} kg/year</p>`
            : `<p class="context-note">üéâ Great job! You're on track for UN 2030 goals!</p>`}
        </div>
      `;
      
      insightsDiv.innerHTML = insights;
      contextSection.style.display = "block";
    }
    
    // Weekly Tracker Functions
    function saveActivity(activity) {
      let activities = loadActivities();
      activities.push(activity);
      // Keep only last 7 days
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      activities = activities.filter(a => new Date(a.date) >= sevenDaysAgo);
      localStorage.setItem("breathegreen_activities", JSON.stringify(activities));
      loadWeeklyTracker();
    }
    
    function loadActivities() {
      const stored = localStorage.getItem("breathegreen_activities");
      return stored ? JSON.parse(stored) : [];
    }
    
    function loadWeeklyTracker() {
      const activities = loadActivities();
      const weeklySection = document.getElementById("weeklyTrackerSection");
      
      if (activities.length === 0) {
        weeklySection.style.display = "none";
        return;
      }
      
      // Sort by date
      activities.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      // Get last 7 days
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      const recentActivities = activities.filter(a => new Date(a.date) >= sevenDaysAgo);
      
      if (recentActivities.length === 0) {
        weeklySection.style.display = "none";
        return;
      }
      
      // Prepare chart data
      const labels = recentActivities.map(a => {
        const date = new Date(a.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      const emissions = recentActivities.map(a => a.emissions);
      const totalWeekly = emissions.reduce((sum, val) => sum + val, 0);
      
      // Update stats
      document.getElementById("weeklyStats").innerHTML = `
        <div class="weekly-stats">
          <div class="stat-item">
            <strong>Total Weekly Emissions:</strong> ${totalWeekly.toFixed(2)} kg CO‚ÇÇ
          </div>
          <div class="stat-item">
            <strong>Average Daily:</strong> ${(totalWeekly / recentActivities.length).toFixed(2)} kg CO‚ÇÇ
          </div>
        </div>
      `;
      
      // Draw chart
      if (weeklyChart) weeklyChart.destroy();
      const ctx = document.getElementById("weeklyChart").getContext("2d");
      weeklyChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Daily Emissions (kg CO‚ÇÇ)",
            data: emissions,
            backgroundColor: "#118a3f",
            borderColor: "#0d6c34",
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "kg CO‚ÇÇ" }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
      
      weeklySection.style.display = "block";
    }
    
    // Initialize Weekly Tracker and Add to Week button handler on page load
    document.addEventListener("DOMContentLoaded", () => {
      // Load weekly tracker
      loadWeeklyTracker();
      
      // Add to Week button handler
      const addToWeekBtn = document.getElementById("addToWeekBtn");
      if (addToWeekBtn) {
        addToWeekBtn.addEventListener("click", () => {
          if (window.currentResult) {
            saveActivity(window.currentResult);
            alert("‚úÖ Added to your weekly tracker!");
            addToWeekBtn.textContent = "‚úì Added to my week";
            addToWeekBtn.disabled = true;
            setTimeout(() => {
              addToWeekBtn.textContent = "üìÖ Add to my week";
              addToWeekBtn.disabled = false;
            }, 2000);
          }
        });
      }
    });
  </script>
</body>
</html>
